<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’è¨˜éŒ²ç®¡ç†</title>
  <style>
    :root {
      /* ä¸»è¦ãªã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ (dashboard.htmlã¨å…±é€š) */
      --color-primary-start: #20b2aa; /* æ˜ã‚‹ã„é’ç·‘ (Teal) */
      --color-primary-end: #008080;    /* æ¿ƒã„é’ç·‘ */
      --color-secondary-start: #48bb78; /* ç·‘ (æˆåŠŸç³») */
      --color-secondary-end: #38a169;    /* æ¿ƒã„ç·‘ */
      --color-danger-start: #f56565;     /* èµ¤ (å‰Šé™¤ç³») */
      --color-danger-end: #e53e3e;       /* æ¿ƒã„èµ¤ */
      --color-edit-start: #ed8936;       /* ã‚ªãƒ¬ãƒ³ã‚¸ (ç·¨é›†ç³») */
      --color-edit-end: #dd6b20;         /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
      --color-info-start: var(--color-secondary-start); 
      --color-info-end: var(--color-secondary-end);     

      /* èƒŒæ™¯ã¨ãƒ†ã‚­ã‚¹ãƒˆ (dashboard.htmlã¨å…±é€š) */
      --color-bg-light: #f4f7f6; /* å…¨ä½“èƒŒæ™¯ã®æ·¡ã„è‰² */
      --color-bg-paper: #ffffff; /* ã‚³ãƒ³ãƒ†ãƒŠèƒŒæ™¯ã®ç™½ */
      --color-text-dark: #2d3748; /* è¦‹å‡ºã—ã€ä¸»è¦ãƒ†ã‚­ã‚¹ãƒˆ */
      --color-text-medium: #4a5568; /* ãƒ©ãƒ™ãƒ«ã€æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ */
      --color-text-light: #f7fafc; /* ç™½æŠœãæ–‡å­— */

      /* ãƒœãƒ¼ãƒ€ãƒ¼ã¨å½± (dashboard.htmlã¨å…±é€š) */
      --color-border: #e2e8f0;
      --shadow-light: 0 5px 15px rgba(0,0,0,0.08);
      --shadow-medium: 0 10px 30px rgba(0,0,0,0.1);
      /* glass-cardã®ã‚·ãƒ£ãƒ‰ã‚¦ã¯dashboard.htmlã§ã®ã¿ä½¿ç”¨ */
      --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
      --shadow-elevated: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--color-text-dark);
    }
    
    .container {
      background: var(--color-bg-paper);
      border-radius: 15px;
      padding: 30px;
      box-shadow: var(--shadow-medium);
      margin-bottom: 20px;
    }
    
    h1 {
      color: var(--color-text-dark);
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      letter-spacing: 1px;
    }
    
    h2 {
      color: var(--color-text-dark);
      border-bottom: 3px solid var(--color-primary-start);
      padding-bottom: 10px;
      margin-top: 30px;
      font-size: 1.8em;
    }
    
    h3 {
      color: var(--color-text-dark);
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 1.4em;
    }

    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--color-text-medium);
    }
    
    input, select, button {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--color-primary-end);
      box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);
      color: var(--color-text-light);
      border: none;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 128, 128, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, var(--color-secondary-start) 0%, var(--color-secondary-end) 100%);
    }
    .btn-secondary:hover {
      box-shadow: 0 5px 15px rgba(56, 161, 105, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--color-danger-start) 0%, var(--color-danger-end) 100%);
      padding: 8px 12px;
      width: auto;
      margin-left: 10px;
      margin-top: 0;
    }
    .btn-danger:hover {
      box-shadow: 0 5px 15px rgba(229, 62, 62, 0.4);
    }
    
    .btn-edit {
      background: linear-gradient(135deg, var(--color-edit-start) 0%, var(--color-edit-end) 100%);
      padding: 8px 12px;
      width: auto;
      margin-left: 5px;
      margin-top: 0;
    }
    .btn-edit:hover {
      box-shadow: 0 5px 15px rgba(221, 107, 32, 0.4);
    }
    
    ul {
      list-style: none;
      padding: 0;
    }
    
    li {
      background: var(--color-bg-light);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid var(--color-primary-start);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-light);
    }
    
    .item-info {
      flex-grow: 1;
      font-weight: 500;
      line-height: 1.5;
      color: var(--color-text-dark);
    }

    .item-info strong {
      color: var(--color-text-dark);
    }
    
    .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--color-secondary-start) 0%, var(--color-secondary-end) 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: var(--shadow-light);
    }
    
    .stat-number {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .hidden {
      display: none;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 20px;
      }

      h2 {
        font-size: 1.6em;
        margin-top: 25px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      li {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-actions {
        width: 100%;
        justify-content: flex-end;
        margin-top: 15px;
      }

      button {
        padding: 10px;
        font-size: 15px;
      }

      .btn-danger, .btn-edit {
        padding: 8px 10px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.4em;
      }
      .stat-number {
        font-size: 1.8em;
      }
      input, select, button {
        font-size: 14px;
        padding: 10px;
      }
    }

    .log-date-header {
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.5em;
      color: var(--color-primary-end);
      text-align: center;
      border-bottom: 2px solid var(--color-border);
      padding-bottom: 5px;
    }

    .daily-summary {
      text-align: center;
      margin: 15px 0 25px;
      font-weight: bold;
      color: var(--color-text-dark);
      font-size: 1.1em;
    }

    @media (max-width: 768px) {
      .log-date-header {
        font-size: 1.3em;
        margin-top: 20px;
        margin-bottom: 10px;
      }
      .daily-summary {
        font-size: 1em;
        margin: 10px 0 20px;
      }
    }

    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .back-to-dashboard-btn {
        display: block;
        width: fit-content;
        margin: 20px auto;
        padding: 10px 20px;
        background: linear-gradient(135deg, var(--color-info-start) 0%, var(--color-info-end) 100%);
        color: var(--color-text-light);
        border: none;
        border-radius: 50px;
        font-weight: bold;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .back-to-dashboard-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š å­¦ç¿’è¨˜éŒ²ç®¡ç†</h1>
    
    <a href="dashboard.html" class="back-to-dashboard-btn">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalItems">0</div>
        <div>å­¦ç¿’é …ç›®æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalLogs">0</div>
        <div>å­¦ç¿’è¨˜éŒ²æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalTime">0</div>
        <div>ç·å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>ğŸ“ å­¦ç¿’é …ç›®ç®¡ç†</h2>
    
    <form id="study-item-form">
      <div class="form-row">
        <div class="form-group">
          <label for="itemName">å­¦ç¿’é …ç›®åï¼š</label>
          <input type="text" id="itemName" required placeholder="ä¾‹: JavaScriptåŸºç¤" />
        </div>
        <div class="form-group">
          <label for="itemCategory">ã‚«ãƒ†ã‚´ãƒªï¼š</label>
          <input type="text" id="itemCategory" required placeholder="ä¾‹: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" />
          <input type="hidden" id="studyItemIdForEdit">
        </div>
      </div>
      <button type="submit" class="btn-secondary">å­¦ç¿’é …ç›®ã‚’è¿½åŠ </button>
      <button type="button" id="cancelStudyItemEdit" class="btn-secondary hidden" style="background: gray; margin-top: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>

    <h3>å­¦ç¿’é …ç›®ä¸€è¦§</h3>
    <ul id="study-items"></ul>
  </div>

  <div class="container">
    <h2>ğŸ“Š å­¦ç¿’ãƒ­ã‚°è¨˜éŒ²</h2>
    
    <form id="log-form">
      <input type="hidden" id="logId">

      <div class="form-row">
        <div class="form-group">
          <label for="studyItemId">å­¦ç¿’é …ç›®ï¼š</label>
          <select id="studyItemId" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="form-group">
          <label for="date">æ—¥ä»˜ï¼š</label>
          <input type="date" id="date" required />
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="content">å­¦ç¿’å†…å®¹ï¼š</label>
          <input type="text" id="content" required placeholder="ä¾‹: å¤‰æ•°ã¨é–¢æ•°ã«ã¤ã„ã¦å­¦ç¿’" />
        </div>
        <div class="form-group">
          <label for="duration">å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰ï¼š</label>
          <input type="number" id="duration" required min="1" placeholder="30" />
        </div>
      </div>
      
      <div class="form-group">
        <label for="memo">ãƒ¡ãƒ¢ï¼š</label>
        <input type="text" id="memo" placeholder="å­¦ç¿’ã®æ„Ÿæƒ³ã‚„æ°—ã¥ã" />
      </div>
      
      <div class="form-group">
        <label for="tags">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ï¼š</label>
        <input type="text" id="tags" placeholder="åŸºç¤, é‡è¦, å¾©ç¿’å¿…è¦" />
      </div>
      
      <button type="submit" id="log-submit-btn" class="btn-secondary">å­¦ç¿’ãƒ­ã‚°ã‚’è¿½åŠ </button>
    </form>
  </div>

  <div class="container">
    <h2>ğŸ“‹ å­¦ç¿’ãƒ­ã‚°ä¸€è¦§</h2>
    <div class="form-group">
      <label for="filterItem">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼š</label>
      <select id="filterItem">
        <option value="">å…¨ã¦ã®é …ç›®</option>
      </select>
    </div>
    <ul id="log-list"></ul>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000'; // ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„
    let studyItems = [];
    let logs = []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° logs ã‚’å®šç¾©

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
    document.getElementById('date').value = new Date().toISOString().split('T')[0];

    // --- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    function getAuthHeaders() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            console.warn('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒLocalStorageã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            // å¿…è¦ã«å¿œã˜ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            // window.location.href = 'dashboard.html'; // ã¾ãŸã¯ login.html
            return {}; // ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã§è¿”ã™ã‹ã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
        }
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }
    // --- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ã“ã“ã¾ã§ ---

    async function loadStudyItems() {
      try {
        const headers = getAuthHeaders();
        // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã‚ãªã„ï¼ˆ401å›é¿ï¼‰
        if (!headers['Authorization']) {
            console.error('å­¦ç¿’é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }

        const res = await fetch(`${API_BASE_URL}/study-items`, { headers: headers });
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒOKã§ãªã„å ´åˆï¼ˆä¾‹: 401 Unauthorizedï¼‰ã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${errorData.message}`);
        }
        studyItems = await res.json();
        updateStudyItemsDisplay();
        updateStats(); // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      } catch (error) {
        console.error('å­¦ç¿’é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      }
    }

    function updateStudyItemsDisplay() {
      const list = document.getElementById('study-items');
      const select = document.getElementById('studyItemId');
      const filterSelect = document.getElementById('filterItem');

      // ãƒªã‚¹ãƒˆã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
      list.innerHTML = '';
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      filterSelect.innerHTML = '<option value="">å…¨ã¦ã®é …ç›®</option>';

      // studyItems ãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ forEach ã‚’å‘¼ã³å‡ºã™
      if (Array.isArray(studyItems)) {
        studyItems.forEach(item => {
          // å­¦ç¿’é …ç›®ä¸€è¦§ã®è¡¨ç¤º
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="item-info">
              <strong>${item.name}</strong> (${item.category})
            </div>
            <div class="item-actions">
              <button class="btn-edit edit-item-btn" data-id="${item.id}">âœï¸ ç·¨é›†</button>
              <button class="btn-danger delete-item-btn" data-id="${item.id}">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
          `;
          list.appendChild(li);

          // å­¦ç¿’ãƒ­ã‚°è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.name;
          select.appendChild(option);

          // å­¦ç¿’ãƒ­ã‚°ä¸€è¦§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
          const filterOption = document.createElement('option');
          filterOption.value = item.id;
          filterOption.textContent = item.name;
          filterSelect.appendChild(filterOption);
        });
      } else {
          console.error("studyItems ã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚", studyItems);
      }

      // å­¦ç¿’é …ç›®ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
      attachStudyItemEventListeners();
    }

    async function loadLogs() { 
      try {
        const headers = getAuthHeaders();
        // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã‚ãªã„ï¼ˆ401å›é¿ï¼‰
        if (!headers['Authorization']) {
            console.error('å­¦ç¿’ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }

        const filterItemId = document.getElementById('filterItem').value;
        const url = filterItemId ? `${API_BASE_URL}/logs?studyItemId=${filterItemId}` : `${API_BASE_URL}/logs`;

        const res = await fetch(url, { headers: headers });
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒOKã§ãªã„å ´åˆï¼ˆä¾‹: 401 Unauthorizedï¼‰ã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${errorData.message}`);
        }
        logs = await res.json(); 
        updateLogsDisplay(); 
        updateStats(); 
      } catch (error) {
        console.error('å­¦ç¿’ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      }
    }

    function updateLogsDisplay() {
      const list = document.getElementById('log-list');
      list.innerHTML = ''; 

      let currentLogs = logs; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° logs ã‚’ä½¿ã†

      // ãƒ­ã‚°ãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚½ãƒ¼ãƒˆã¨forEachã‚’å‘¼ã³å‡ºã™
      if (Array.isArray(currentLogs)) {
        // ãƒ­ã‚°ã‚’æ—¥ä»˜ã¨ä½œæˆæ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„æ—¥ä»˜ãŒä¸Šã€åŒã˜æ—¥ä»˜å†…ã§ã¯æ–°ã—ã„æ™‚é–“ãŒä¸Šï¼‰
        currentLogs.sort((a, b) => {
          // createdAtãŒå­˜åœ¨ã—ãªã„å ´åˆã‚„ç„¡åŠ¹ãªå ´åˆã¯ã€dateã®ã¿ã‚’ä½¿ç”¨
          const dateA = new Date(a.createdAt || a.date);
          const dateB = new Date(b.createdAt || b.date);
          
          // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
          const dateCompare = dateB - dateA;
          if (dateCompare !== 0) return dateCompare;

          // åŒã˜æ—¥ä»˜ã®å ´åˆã€createdAtã§ã‚½ãƒ¼ãƒˆï¼ˆã‚ˆã‚Šæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰
          // createdAtãŒä¸¡æ–¹ã¨ã‚‚å­˜åœ¨ã—ãªã„å ´åˆã¯é †åºã‚’ç¶­æŒ
          if (a.createdAt && b.createdAt) {
            return new Date(b.createdAt) - new Date(a.createdAt);
          }
          return 0; 
        });

        let currentDate = '';
        let dailyTotalMinutes = 0;

        currentLogs.forEach((log, index) => {
          const logDate = log.date; 

          // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ã€å‰æ—¥ã®åˆè¨ˆæ™‚é–“ã‚’è¡¨ç¤ºï¼ˆåˆå›ä»¥å¤–ï¼‰
          if (logDate !== currentDate) {
            if (currentDate !== '') {
              const dailyHours = Math.floor(dailyTotalMinutes / 60);
              const dailyMinutes = dailyTotalMinutes % 60;
              const dailyTotalDiv = document.createElement('div');
              dailyTotalDiv.className = 'daily-summary'; 
              dailyTotalDiv.innerHTML = `
                ${currentDate}ã®åˆè¨ˆå­¦ç¿’æ™‚é–“: ${dailyHours}æ™‚é–“${dailyMinutes}åˆ†
              `;
              list.appendChild(dailyTotalDiv);
            }
            const dateHeader = document.createElement('h3');
            dateHeader.textContent = logDate;
            dateHeader.className = 'log-date-header'; 
            list.appendChild(dateHeader);
            currentDate = logDate;
            dailyTotalMinutes = 0; 
          }

          dailyTotalMinutes += parseInt(log.duration);

          const li = document.createElement('li');
          const studyItem = studyItems.find(item => item.id === log.studyItemId);
          const itemName = studyItem ? studyItem.name : 'ä¸æ˜ãªé …ç›®';

          // createdAtãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¿®æ­£
          const displayTime = log.createdAt ? log.createdAt.substring(11, 16) : ''; // HH:MMå½¢å¼
          const displayDateAndTime = `${log.date} ${displayTime}`.trim(); // ã‚¹ãƒšãƒ¼ã‚¹ã®èª¿æ•´

          li.innerHTML = `
            <div class="item-info">
              <strong>${itemName}</strong> - ${log.duration}åˆ†<br>
              ğŸ“– ${log.content}<br>
              ${log.memo ? `ğŸ’­ ${log.memo}<br>` : ''}
              ${log.tags && log.tags.length > 0 ? `ğŸ·ï¸ ${log.tags.join(', ')}<br>` : ''}
              <small>${displayDateAndTime}</small>
            </div>
            <div class="item-actions">
              <button class="btn-edit edit-btn" data-id="${log.id}">âœï¸ ç·¨é›†</button>
              <button class="btn-danger delete-btn" data-id="${log.id}">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
          `;
          list.appendChild(li);

          // æœ€å¾Œã®è¦ç´ ã®å ´åˆã€æ—¥è¨ˆã‚’è¡¨ç¤º
          if (index === currentLogs.length - 1) {
            const dailyHours = Math.floor(dailyTotalMinutes / 60);
            const dailyMinutes = dailyTotalMinutes % 60;
            const dailyTotalDiv = document.createElement('div');
            dailyTotalDiv.className = 'daily-summary';
            dailyTotalDiv.innerHTML = `
              ${currentDate}ã®åˆè¨ˆå­¦ç¿’æ™‚é–“: ${dailyHours}æ™‚é–“${dailyMinutes}åˆ†
            `;
            list.appendChild(dailyTotalDiv);
          }
        });
      } else {
          console.error("logs ã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚", logs);
      }

      attachLogEventListeners();
    }

    function attachLogEventListeners() {
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async () => {
          if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            const id = button.getAttribute('data-id');
            try {
              const headers = getAuthHeaders();
              if (!headers['Authorization']) { return; } // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã‘ã‚Œã°å‡¦ç†ã—ãªã„

              const res = await fetch(`${API_BASE_URL}/logs/${id}`, { method: 'DELETE', headers: headers });
              if (!res.ok) {
                  const errorData = await res.json();
                  throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${errorData.message}`);
              }
              await loadLogs(); 
            } catch (error) {
              alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
              console.error('å­¦ç¿’ãƒ­ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            }
          }
        });
      });

      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', () => {
          const id = button.getAttribute('data-id');
          const log = logs.find(l => l.id === id); 

          if (log) {
            document.getElementById('logId').value = log.id;
            document.getElementById('studyItemId').value = log.studyItemId;
            document.getElementById('date').value = log.date;
            document.getElementById('content').value = log.content;
            document.getElementById('duration').value = log.duration;
            document.getElementById('memo').value = log.memo || '';
            document.getElementById('tags').value = log.tags.join(',');
            document.getElementById('log-submit-btn').textContent = 'å­¦ç¿’ãƒ­ã‚°ã‚’æ›´æ–°';

            document.getElementById('log-form').scrollIntoView({
              behavior: 'smooth'
            });
          }
        });
      });
    }

    function attachStudyItemEventListeners() {
      // å‰Šé™¤ãƒœã‚¿ãƒ³
      document.querySelectorAll('.delete-item-btn').forEach(button => {
        button.addEventListener('click', async () => {
          if (confirm('ã“ã®å­¦ç¿’é …ç›®ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®é …ç›®ã«é–¢é€£ã™ã‚‹å­¦ç¿’ãƒ­ã‚°ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚')) {
            const id = button.getAttribute('data-id');
            try {
              const headers = getAuthHeaders();
              if (!headers['Authorization']) { return; } // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã‘ã‚Œã°å‡¦ç†ã—ãªã„

              const res = await fetch(`${API_BASE_URL}/study-items/${id}`, {
                method: 'DELETE',
                headers: headers
              });
              if (res.ok) {
                alert('å­¦ç¿’é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼');
                await loadStudyItems(); 
                await loadLogs(); 
              } else {
                const errorData = await res.json();
                alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.message}`);
              }
            } catch (error) {
              console.error('å­¦ç¿’é …ç›®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
              alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
          }
        });
      });

      // ç·¨é›†ãƒœã‚¿ãƒ³
      document.querySelectorAll('.edit-item-btn').forEach(button => {
        button.addEventListener('click', () => {
          const id = button.getAttribute('data-id');
          const itemToEdit = studyItems.find(item => item.id === id);

          if (itemToEdit) {
            document.getElementById('studyItemIdForEdit').value = itemToEdit.id;
            document.getElementById('itemName').value = itemToEdit.name;
            document.getElementById('itemCategory').value = itemToEdit.category;

            document.querySelector('#study-item-form button[type="submit"]').textContent = 'å­¦ç¿’é …ç›®ã‚’æ›´æ–°';

            document.getElementById('cancelStudyItemEdit').classList.remove('hidden');

            document.getElementById('study-item-form').scrollIntoView({
              behavior: 'smooth'
            });
          }
        });
      });
    }

    function updateStats() {
      document.getElementById('totalItems').textContent = studyItems.length;
      document.getElementById('totalLogs').textContent = logs.length;

      const totalMinutes = logs.reduce((sum, log) => sum + (parseInt(log.duration) || 0), 0);

      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      document.getElementById('totalTime').textContent =
        `${totalMinutes}åˆ† ï¼ˆ${hours}æ™‚é–“${minutes}åˆ†ï¼‰`;
    }

    // å­¦ç¿’é …ç›®è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById('study-item-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('itemName').value;
      const category = document.getElementById('itemCategory').value;
      const studyItemIdForEdit = document.getElementById('studyItemIdForEdit').value;

      try {
        const headers = getAuthHeaders();
        if (!headers['Authorization']) { 
            alert('èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            return; 
        }

        let res;
        if (studyItemIdForEdit) {
          res = await fetch(`${API_BASE_URL}/study-items/${studyItemIdForEdit}`, {
            method: 'PUT',
            headers: headers, // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨
            body: JSON.stringify({
              name,
              category
            })
          });
        } else {
          res = await fetch(`${API_BASE_URL}/study-items`, {
            method: 'POST',
            headers: headers, // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨
            body: JSON.stringify({
              name,
              category
            })
          });
        }

        if (res.ok) {
          document.getElementById('study-item-form').reset();
          document.getElementById('studyItemIdForEdit').value = '';
          document.querySelector('#study-item-form button[type="submit"]').textContent = 'å­¦ç¿’é …ç›®ã‚’è¿½åŠ ';

          document.getElementById('cancelStudyItemEdit').classList.add('hidden');

          await loadStudyItems();
          await loadLogs();
          alert(studyItemIdForEdit ? 'å­¦ç¿’é …ç›®ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'å­¦ç¿’é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        } else {
          const errorData = await res.json();
          alert(`å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.message}`);
        }
      } catch (error) {
        console.error('å­¦ç¿’é …ç›®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    });

    // å­¦ç¿’ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById('log-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const logId = document.getElementById('logId').value;
      const studyItemId = document.getElementById('studyItemId').value;
      const date = document.getElementById('date').value;
      const content = document.getElementById('content').value;
      const duration = parseInt(document.getElementById('duration').value);
      const memo = document.getElementById('memo').value;
      const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);

      const payload = {
        studyItemId,
        date,
        content,
        duration,
        memo,
        tags
      };

      try {
        const headers = getAuthHeaders();
        if (!headers['Authorization']) { 
            alert('èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            return; 
        }

        if (logId) {
          // ç·¨é›†
          const res = await fetch(`${API_BASE_URL}/logs/${logId}`, {
            method: 'PUT',
            headers: headers, // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
              const errorData = await res.json();
              throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${errorData.message}`);
          }
        } else {
          // æ–°è¦è¿½åŠ 
          const res = await fetch(`${API_BASE_URL}/logs`, {
            method: 'POST',
            headers: headers, // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
              const errorData = await res.json();
              throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${errorData.message}`);
          }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('log-form').reset();
        document.getElementById('logId').value = '';
        document.getElementById('log-submit-btn').textContent = 'å­¦ç¿’ãƒ­ã‚°ã‚’è¿½åŠ ';
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        // å†èª­ã¿è¾¼ã¿
        await loadLogs(); 

        alert(logId ? 'å­¦ç¿’ãƒ­ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'å­¦ç¿’ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
      } catch (error) {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        console.error('å­¦ç¿’ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    });

    // å­¦ç¿’é …ç›®ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    document.getElementById('cancelStudyItemEdit').addEventListener('click', () => {
      document.getElementById('study-item-form').reset();
      document.getElementById('studyItemIdForEdit').value = '';
      document.querySelector('#study-item-form button[type="submit"]').textContent = 'å­¦ç¿’é …ç›®ã‚’è¿½åŠ ';
      document.getElementById('cancelStudyItemEdit').classList.add('hidden');
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
    document.getElementById('filterItem').addEventListener('change', () => {
      loadLogs();
    });

    // åˆæœŸåŒ– (ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œ)
    (async () => {
      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      if (!localStorage.getItem('jwt_token')) {
          console.warn("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚");
          alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚");
          window.location.href = 'dashboard.html';
          return;
      }
      await loadStudyItems();
      await loadLogs();
    })();
  </script>
</body>
</html>